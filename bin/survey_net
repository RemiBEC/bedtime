#!/usr/bin/perl

#use warnings;
use strict;

# Get the dhcp server lines from the client lease files
my @lease_files = `find /var -name *.leases | grep client`;
my @servers;
foreach (@lease_files) {
   open (LEASES, $_);
   my @lines = <LEASES>;
   close LEASES;
   foreach (@lines) {
      m/option dhcp-server-identifier\s+/;
      my $server = $';
      $server =~ s/;//;
      chomp($server);
      push (@servers,$server) unless ($server eq '');
   }
}

# Find the unique dhcp server
my %seen;
@servers = grep {! $seen{$_}++ } @servers;
# Pick the last value
my $dhcp = pop(@servers);

# Write the result in the network file
open (OUT, ">/usr/share/bedtime/network");
print OUT "$dhcp/dhcp\n";

# Now find the IP address(es)
my @ip = `ip addr show | grep global`;
foreach (@ip) {
   # Match inet IP/mask
   if (m/inet (\d{1,3}\.){3}(\d{1,3})\/(\d{1,2})/) {
      my $ip = $&;
      $ip =~ s/^inet //;
      print OUT "$ip\n";
   }
}
close OUT;
